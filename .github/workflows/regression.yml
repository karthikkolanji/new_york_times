on:
  push:
    branch:
      - 'cicdTest/*'

name: Regression buid workflow


jobs:
  job1:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v2

      - name: Set up Python ${{ matrix.python-version }}
        uses: actions/setup-python@v1
        with:
          python-version: 3.8

      - name: Install pip
        run: |
          python -m pip install --upgrade pip
          pip install -r .github/workflows/requirements.txt


      - name: Generate Change logs
        id: changelogs
        working-directory: .github/workflows/
        run: python release_mail_generator.py ${{ secrets.GITHUB_TOKEN }}  v2.21


      - name: Setup JDK 1.8
        uses: actions/setup-java@master
        with:
          java-version: 1.8

      - name: Make Gradle executable
        run: chmod +x ./gradlew

      - name: Build Release APK
        run: bash ./gradlew assembleProdFlavourDebug

      - name: Echo
        run: |
          echo ${{ steps.branch_name.outputs.branch }}



#      - name: Signing .apk with release key
#        uses: r0adkll/sign-android-release@v1.0.1
#        with:
#          releaseDirectory: app/build/outputs/apk/prodFlavour/release/app-prodFlavour-release.apk
#          signingKeyBase64: ${{ secrets.SIGNING_KEY }}
#          alias: ${{ secrets.KEY_ALIAS }}
#          keyStorePassword: ${{ secrets.KEY_STORE_PASSWORD }}
#          keyPassword: ${{ secrets.KEY_STORE_PASSWORD }}


#      - name: Save generated .apk file
#        uses: actions/upload-artifact@v2
#        with:
#          name: newYorlTimes
#          path: app/build/outputs/apk/prodFlavour/debug/app-prodFlavour-debug.apk


      - name: Send mail
        uses: dawidd6/action-send-mail@v2
        with:
          server_address: smtp.gmail.com
          server_port: 465
          username: ${{ secrets.GMAIL_USER_NAME }}
          password: ${{ secrets.GMAIL_PASSWORD }}
          subject: Android Regression CI/CD Test
          # Literal body:
          body: ${{ secrets.EMAIL_BODY }}
          to: karthik@okcredit.in
          from: ${{ secrets.GMAIL_USER_NAME }}
          ## Optional content type (defaults to text/plain):
          content_type: text/html
          # Optional attachments:
          #attachments: app/build/outputs/apk/prodFlavour/artifacts/newYorlTimes



        # - name: Upload generated mapping file
        # uses: actions/upload-artifact@v2
        # with:
        #   name: mapping
        #  path: app/build/outputs/mapping/prodGoogleRelease/mapping.txt



      # - name: Download generated mapping file
      #   uses: actions/download-artifact@v2
      #  with:
      #   name: mapping
      #   path: app/build/outputs/mapping/prodGoogleRelease/mapping.txt

      - name: Slack uploading
        uses: adrey/slack-file-upload-action@master
        with:
          token: ${{ secrets.SLACK_SECRETS }}
          initial_comment: Release Build for Branch ``` ${{github.event.pull_request.head.ref}} ```
            Author ```${{github.event.sender.login}}```
            Title ```${{github.event.pull_request.title}}```
            URL ${{github.event.pull_request.url}}
            ```${{github.event.pull_request.body}}```
          path: app/build/outputs/apk/prodFlavour/debug/app-prodFlavour-debug.apk
          channel: android_ci_cd_test


      - name: Upload to Google Drive
        uses: satackey/action-google-drive@v1
        with:
          skicka-tokencache-json: ${{ secrets.SKICKA_TOKENCACHE_JSON }}
          upload-from: app/build/outputs/apk/prodFlavour/debug/app-prodFlavour-debug.apk
          upload-to: /release_apks


#      - name: Slack Notification
#        uses: rtCamp/action-slack-notify@v2.0.0
#        env:
#          SLACK_CHANNEL: android_ci_cd_test
#          SLACK_COLOR: '#3278BD'
#          SLACK_ICON: https://github.com/rtCamp.png?size=48
#          SLACK_MESSAGE: 'Post Content :rocket:'
#          SLACK_TITLE: Post Title
#          SLACK_USERNAME: rtCamp
#          SLACK_WEBHOOK: ${{secrets.SLACK_WEBHOOK}}


#      - uses: 8398a7/action-slack@v3
#        with:
#          status: ${{ job.status }}
#          fields: repo,message,commit,author,action,eventName,ref,workflow # selectable (default: repo,message)
#        env:
#          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }} # optional
#          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK }} # required
#        if: always() # Pick up events even if the job fails or is canceled.



#      - name: Slack notification
#        env:
#          SLACK_WEBHOOK: https://hooks.slack.com/services/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
#          SLACK_USERNAME: ThisIsMyUsername # Optional. (defaults to webhook app)
#          SLACK_CHANNEL: general # Optional. (defaults to webhook)
#          SLACK_AVATAR: repository # Optional. can be (repository, sender, an URL) (defaults to webhook app avatar)
#        uses: Ilshidur/action-slack@master
#        with:
#          args: 'A new commit has been pushed.' # Optional
